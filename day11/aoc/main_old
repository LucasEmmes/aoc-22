#include <QCoreApplication>


#include "../../common/filereader.h"

#include <functional>
#include <memory>
#include <queue>

void split_line(std::string& line, std::vector<std::string>& collector) {
    collector.clear();
    std::stringstream ss(line);
    std::string temp_str;
    while (ss >> temp_str) collector.push_back(temp_str);
}

class Monkey{
public:
    int business = 0;
    std::queue<int> items;
    std::function<int(int)> op_func;
    std::function<int(int)> test_func;

    void perform_turn(std::vector<std::shared_ptr<Monkey>>& monkies) {
        while (items.size()) {
            int item = items.front();
            item = item % 9699690;
            // Perform operation
            item = op_func(item);
            // Calm down
            item /= 3;
            // Throw to next monkey
            int next_monkey = test_func(item);
            monkies[next_monkey]->items.push(item);
            items.pop();
            business++;
        }
    }
};

int main(int argc, char *argv[]) {
    QCoreApplication a(argc, argv);

    auto lines = aoc_read_lines_raw();
    std::vector<std::shared_ptr<Monkey>> monkies;

    std::vector<std::string> line;
    for (size_t i = 0; i < lines.size(); i+=7) {
        auto m = std::make_shared<Monkey>();
        monkies.push_back(m);

        // Get value of items
        split_line(lines[i+1], line);
        for (size_t j = 2; j < line.size(); j++)
            m->items.push(std::stoi(line[j]));

        // Get operation to perform
        split_line(lines[i+2], line);
        std::function<const int(const int, const int)> operation = line[4][0] == '+' ?
                (std::function<const int(const int, const int)>) std::plus<int>{} :
                (std::function<const int(const int, const int)>) std::multiplies<int>{};
        if (line[5][0] == 'o')
            m->op_func = [=](int item){ return operation(item, item); };
        else
            m->op_func = [=](int item){ return operation(item, std::stoi(line[5])); };

        // Get test to perform
        m->test_func = [=](int item){return item % std::stoi(lines[i+3].substr(21)) == 0 ?
                std::stoi(lines[i+4].substr(29)) : std::stoi(lines[i+5].substr(30)); };

    }

    for (size_t i = 0; i < 20; i++) {
        for (auto& monkey : monkies) {
            monkey->perform_turn(monkies);
        }
    }

        std::sort(monkies.begin(), monkies.end(), [](std::shared_ptr<Monkey> lhs, std::shared_ptr<Monkey> rhs)
        {return lhs->business > rhs->business;});
    std::cout << (monkies[0]->business * monkies[1]->business) << std::endl;
    return 0;
}
